name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  PYTHON_VERSION: "3.11"

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository code (required for all following steps)
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Python for test and lint steps
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Install Python dependencies required for tests, linting and vulnerability scan
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt pytest ruff pip-audit

      # Lint the codebase and verify formatting (ruff)
      - name: Lint & format check
        run: |
          set -o pipefail
          ruff check . | tee /tmp/ruff_check.log
          ruff format --check . | tee /tmp/ruff_format.log
          {
            echo "### Lint & Format"
            echo '```'
            cat /tmp/ruff_check.log
            cat /tmp/ruff_format.log
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      # Run unit tests with pytest
      - name: Run unit tests
        run: |
          set -o pipefail
          pytest | tee /tmp/pytest.log
          {
            echo "### Unit Tests"
            echo '```'
            cat /tmp/pytest.log
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      # Build the Docker image and tag it with the commit SHA (immutable) + latest
      - name: Build Docker image
        id: build-image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_REF=aiclipx-devops-trial:${IMAGE_TAG}
          docker build --pull --no-cache -t "${IMAGE_REF}" -t aiclipx-devops-trial:latest app
          echo "image_ref=${IMAGE_REF}" >> "$GITHUB_OUTPUT"

      # Quick check: list images to help debugging if later steps fail to find the image
      - name: List Docker images (debug)
        run: docker images --filter=reference='aiclipx-devops-trial*'

      # Scan Python dependencies for known vulnerabilities (pip-audit)
      - name: Dependency vulnerability scan
        run: |
          pip-audit --progress-spinner off

      # Run Trivy image scan
      # - Purpose: scan the built Docker image for OS and library vulnerabilities.
      # - Behavior: exit code 1 fails the job when HIGH/CRITICAL vulnerabilities are found.
      # - Input: uses the image reference exported earlier into `IMAGE_REF`.
      # Trivy image scan (official action) + export to GitHub Step Summary
      # Vulnerability/misconfig/secret scan
      - name: Run Trivy vulnerability scan on image
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2
        with:
          scan-type: 'image'
          image-ref: ${{ steps.build-image.outputs.image_ref }}
          format: 'table'
          output: 'trivy-report.txt'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,misconfig'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '1'

      - name: Add Trivy report to GitHub Summary
        if: always()
        run: |
          if [ -f trivy-report.txt ]; then
            {
              echo '## Trivy Vulnerability Report (CRITICAL/HIGH)'
              echo
              echo '```'
              cat trivy-report.txt
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo 'No Trivy report generated.' >> "$GITHUB_STEP_SUMMARY"
          fi

      # Secret scanning with Gitleaks
      # - Purpose: scan the repository for high-risk secrets (API keys, passwords, tokens).
      # - Behavior: the action will fail the job if finds potential secrets depending on configuration.
      # - Note: tune `.gitleaks.toml` or action args for false-positive handling in larger repos.
      - name: Secret scanning
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --source . --no-banner --verbose
