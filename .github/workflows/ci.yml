name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  PYTHON_VERSION: "3.11"

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository code (required for all following steps)
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Python for test and lint steps
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Install Python dependencies required for tests, linting and vulnerability scan
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt pytest ruff pip-audit

      # Lint the codebase and verify formatting (ruff)
      - name: Lint & format check
        run: |
          ruff check .
          ruff format --check .

      # Run unit tests with pytest
      - name: Run unit tests
        run: pytest

      # Build the Docker image and tag it with the commit SHA (immutable) + latest
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t aiclipx-devops-trial:${IMAGE_TAG} -t aiclipx-devops-trial:latest app
          # Export the image reference for downstream steps
          echo "IMAGE_REF=aiclipx-devops-trial:${IMAGE_TAG}" >> $GITHUB_ENV

      # Quick check: list images to help debugging if later steps fail to find the image
      - name: List Docker images (debug)
        run: docker images --filter=reference='aiclipx-devops-trial*'

      # Scan Python dependencies for known vulnerabilities (pip-audit)
      - name: Dependency vulnerability scan
        run: pip-audit

      # Install Trivy CLI and scan the built Docker image for OS and library vulnerabilities
      - name: Install Trivy CLI
        run: |
          # Pin version for reproducibility; update when needed
          TRIVY_VERSION=0.44.0
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin ${TRIVY_VERSION}

      # Run Trivy image scan
      # - Purpose: scan the built Docker image for OS and library vulnerabilities.
      # - Behavior: exit code 1 fails the job when HIGH/CRITICAL vulnerabilities are found.
      # - Input: uses the image reference exported earlier into `IMAGE_REF`.
      - name: Run Trivy image scan
        env:
          IMAGE_REF: ${{ env.IMAGE_REF }}
        run: |
          echo "Scanning image: ${IMAGE_REF}"
          # Fail the job on detected HIGH/CRITICAL vulnerabilities
          trivy image --no-progress --format table --exit-code 1 --severity HIGH,CRITICAL ${IMAGE_REF}

      # Secret scanning with Gitleaks
      # - Purpose: scan the repository for high-risk secrets (API keys, passwords, tokens).
      # - Behavior: the action will fail the job if finds potential secrets depending on configuration.
      # - Note: tune `.gitleaks.toml` or action args for false-positive handling in larger repos.
      - name: Secret scanning
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --source . --no-banner --verbose
